<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PyScript Dynamic Execution ‚Äì With Packages</title>
  <!-- Stable Core build -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  
  <!-- ****************************************************** -->
  <!-- ** NEW: Add py-config to declare needed packages ** -->
  <!-- ****************************************************** -->
  <py-config>
    packages = ["numpy"]
  </py-config>

  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    h2 { margin-top: 2rem; }
    h3 { margin-top: 1.5rem; }
    .box { padding: 0.5rem; margin: 0.5rem 0; border-left: 4px solid #ccc; background: #f9f9f9; white-space: pre-wrap; }
    button { margin-right: 0.5rem; margin-bottom: 0.5rem; }
    textarea { width: 100%; box-sizing: border-box; background: #fdfdfd; border: 1px solid #ccc; }
    .success { color: green; }
    .error   { color: red; }
  </style>
</head>
<body>

  <h1>üß™ PyScript Dynamic Execution ‚Äì With Packages</h1>
  <h2>‚úÖ Initialization Tests</h2>
  <div id="display-output" class="box"></div>

  <hr>

  <h2>üîÄ Dynamic Execution Methods</h2>
  <button onclick="method1()">Method 1: Simple Callback</button>
  <button onclick="method2()">Method 2: Execute Code via Callback</button>
  <button onclick="method3()">Method 3: Inject &lt;py-script&gt; Tag</button>
  <button onclick="method4()">Method 4: Capture `print` via Callback</button>

  <h3>‚ñ∂Ô∏è Method 1 Output (Simple Callback)</h3>
  <div id="dynamic-1" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 2 Output (Execute Code)</h3>
  <div id="dynamic-2" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 3 Output (Injection)</h3>
  <div id="dynamic-3" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 4 Output (Capture `print`)</h3>
  <div id="dynamic-4" class="box"></div>

  <hr>

  <h2>üöÄ Live Code Execution Test</h2>
  <p>Type any Python code below and run it. <b>Numpy is now available.</b></p>
  <textarea id="custom-code-area" rows="6">
import numpy as np

# This will now work because numpy is loaded via py-config
a = np.array([1, 2, 3, 4, 5])
print(f"My numpy array: {a}")
print(f"The sum is: {np.sum(a)}")
print(f"The mean is: {np.mean(a)}")
  </textarea>
  <button onclick="runCustomCode()">Run Custom Code</button>
  <h3>‚ñ∂Ô∏è Live Code Output</h3>
  <div id="custom-code-output" class="box"></div>


  <!-- Initialization block with all callback functions -->
  <py-script>
import js
from js import console, document
import sys
import io
from pyscript import display
from pyodide.ffi import create_proxy

# --- Initial Display ---
display(f"‚úÖ PyScript Initialized. Python {sys.version}", target="display-output")

# --- Callbacks (Unchanged) ---
def dynamic_run(msg):
    display(f"‚úÖ Method 1 (Simple Callback) says: {msg}", target="dynamic-1")

def exec_direct(code):
    try:
        exec(code)
    except Exception as e:
        raise e

def exec_and_capture_print(code, target_id):
    output_el = document.getElementById(target_id)
    output_el.classList.remove("error")
    old_stdout = sys.stdout
    old_stderr = sys.stderr
    redirected_output = io.StringIO()
    redirected_error = io.StringIO()
    sys.stdout = redirected_output
    sys.stderr = redirected_error
    try:
        exec(code)
        sys.stdout = old_stdout
        sys.stderr = old_stderr
        
        err = redirected_error.getvalue()
        if err:
            output_el.classList.add("error")
            display(err, target=target_id)
        else:
            display(redirected_output.getvalue(), target=target_id)
    except Exception as e:
        sys.stdout = old_stdout
        sys.stderr = old_stderr
        output_el.classList.add("error")
        display(str(e), target=target_id)

# --- Expose all functions to JavaScript ---
js.dynamic_run = create_proxy(dynamic_run)
js.exec_direct = create_proxy(exec_direct)
js.exec_and_capture_print = create_proxy(exec_and_capture_print)

  </py-script>

  <!-- JavaScript block (Unchanged) -->
  <script>
    function method1() { if (window.dynamic_run) window.dynamic_run("Hello from JS!"); }

    function method2() {
      const code = `from pyscript import display; display("‚úÖ Method 2 (Execute Code via Callback) worked!", target="dynamic-2")`;
      try { if(window.exec_direct) window.exec_direct(code); } 
      catch (err) { document.getElementById("dynamic-2").innerText = "‚ùå Method 2 Failed: " + err; }
    }

    function method3() {
      const tag = document.createElement("py-script");
      tag.textContent = `from pyscript import display; display("‚úÖ Method 3 (Tag Injection) worked!", target="dynamic-3")`;
      document.body.appendChild(tag);
    }

    function method4() {
      const code = `print("‚úÖ Method 4 ('print' capture) worked!")\nprint("   This text was captured from stdout.")`;
      try { if(window.exec_and_capture_print) window.exec_and_capture_print(code, "dynamic-4"); }
      catch (err) { document.getElementById("dynamic-4").innerText = "‚ùå Method 4 Failed: " + err; }
    }

    function runCustomCode() {
      const code = document.getElementById("custom-code-area").value;
      const outputEl = document.getElementById("custom-code-output");
      outputEl.textContent = '';
      try {
        if (window.exec_and_capture_print) {
          window.exec_and_capture_print(code, "custom-code-output");
        } else {
           outputEl.innerText = "‚ùå Callback 'exec_and_capture_print' not ready.";
        }
      } catch(err) {
        outputEl.classList.add("error");
        outputEl.innerText = "‚ùå JavaScript-level error: " + err;
      }
    }
  </script>

  <noscript>
    <p class="error">‚ùå JavaScript is disabled ‚Äì PyScript cannot run.</p>
  </noscript>

</body>
</html>
