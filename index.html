<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PyScript Dynamic Execution ‚Äì Final & Robust</title>
  <!-- Stable Core build -->
  <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    h2 { margin-top: 2rem; }
    .box { padding: 0.5rem; margin: 0.5rem 0; border-left: 4px solid #ccc; background: #f9f9f9; }
    button { margin-right: 0.5rem; margin-bottom: 0.5rem; }
    button:disabled { cursor: not-allowed; opacity: 0.6; }
    .success { color: green; }
    .error   { color: red; }
  </style>
</head>
<body>

  <h1>üß™ PyScript Dynamic Execution ‚Äì Final & Robust</h1>

  <h2>‚úÖ Initialization Tests</h2>
  <div id="version-output" class="box"></div>
  <div id="display-output" class="box"></div>

  <hr>

  <h2>üîÄ Dynamic Execution Methods</h2>
  <button onclick="method1()">Method 1: Call Python callback</button>
  <!-- FIX 1: Start buttons disabled until the interpreter is ready -->
  <button id="btn-method-2" onclick="method2()" disabled>Method 2: interpreter.run() with `display()`</button>
  <button onclick="method3()">Method 3: Inject &lt;py-script&gt; with `display()`</button>
  <button id="btn-method-4" onclick="method4()" disabled>Method 4: interpreter.run() with `print()`</button>

  <h3>‚ñ∂Ô∏è Method 1 Output (callback)</h3>
  <div id="dynamic-1" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 2 Output (run with `display`)</h3>
  <div id="dynamic-2" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 3 Output (injection with `display`)</h3>
  <div id="dynamic-3" class="box"></div>

  <h3>‚ñ∂Ô∏è Method 4 Output (run with `print`)</h3>
  <div id="dynamic-4" class="box"></div>

  <hr>

  <!-- Initialization block -->
  <py-script id="main-pyscript">
import js
from js import console, document
import sys
from pyscript import display
from pyodide.ffi import create_proxy

# 1. Basic display() test:
display(f"‚úÖ Static display() works. Python {sys.version}", target="display-output")
document.getElementById("version-output").innerText = f"‚úÖ Direct DOM manipulation works."

# 2. Define the callback for Method 1:
def dynamic_run(msg):
    display(f"‚úÖ Method 1 callback says: {msg}", target="dynamic-1")

js.dynamic_run = create_proxy(dynamic_run)
  </py-script>

  <script>
    // Store a reference to the interpreter once it's ready.
    let mainInterpreter;

    // FIX 2: Wait for the 'py:done' event before enabling buttons and saving the interpreter.
    document.addEventListener('DOMContentLoaded', () => {
        const mainPy = document.getElementById('main-pyscript');
        mainPy.addEventListener('py:done', () => {
            console.log("PyScript main interpreter is ready.");
            mainInterpreter = mainPy.interpreter;

            // Now that the interpreter is guaranteed to exist, enable the buttons.
            document.getElementById('btn-method-2').disabled = false;
            document.getElementById('btn-method-4').disabled = false;
        });
    });


    // Method 1: call the Python callback exposed with create_proxy
    function method1() {
      // This check implicitly waits for Python to be ready enough to create the proxy.
      if (window.dynamic_run) {
        window.dynamic_run("Hello from JS ‚Üí Python callback!");
      } else {
        document.getElementById("dynamic-1").innerText = "‚ùå Callback not ready yet.";
      }
    }

    // Method 2: interpreter.run() with `pyscript.display(target=...)`
    async function method2() {
      // FIX 3: Use the globally stored interpreter reference.
      if (!mainInterpreter) {
        document.getElementById("dynamic-2").innerText = "‚ùå Interpreter not available.";
        return;
      }
      const code = `
from pyscript import display
display("‚úÖ Method 2: interpreter.run() with <b>display(target=...)</b> worked!", target="dynamic-2")
`;
      try {
        await mainInterpreter.run(code);
      } catch (err) {
        console.error("Method 2 error:", err);
        document.getElementById("dynamic-2").innerText = "‚ùå Method 2 failed: " + err;
      }
    }

    // Method 3: inject a new <py-script> tag. This works without changes as it
    // triggers the PyScript runtime to process a new tag whenever it's added.
    function method3() {
      try {
        const tag = document.createElement("py-script");
        tag.textContent = `
from pyscript import display
display("‚úÖ Method 3: injected &lt;py-script&gt; with <b>display(target=...)</b> worked!", target="dynamic-3")
`;
        document.body.appendChild(tag);
      } catch (err) {
        console.error("Method 3 error:", err);
        document.getElementById("dynamic-3").innerText = "‚ùå Method 3 failed: " + err;
      }
    }

    // Method 4: interpreter.run() with `print()` and the `output` option.
    async function method4() {
        // FIX 4: Use the globally stored interpreter reference.
        if (!mainInterpreter) {
          document.getElementById("dynamic-4").innerText = "‚ùå Interpreter not available.";
          return;
        }
        const code = `
# This is a standard Python print() statement
print("‚úÖ Method 4: interpreter.run() with print() and the 'output' option worked!")
`;
        try {
            await mainInterpreter.run(code, { output: "dynamic-4" });
        } catch (err) {
            console.error("Method 4 error:", err);
            document.getElementById("dynamic-4").innerText = "‚ùå Method 4 failed: " + err;
        }
    }
  </script>

  <noscript>
    <p class="error">‚ùå JavaScript is disabled ‚Äì PyScript cannot run.</p>
  </noscript>

</body>
</html>
